<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo dõi Kế hoạch Bảo dưỡng Sửa chữa</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: #f4f4f9; line-height: 1.6;
        }
        #container {
            max-width: 1400px; margin: auto; background-color: white;
            padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: block; /* Sửa: Hiển thị nội dung chính theo mặc định */
        }
        #login-container {
            display: none; /* Sửa: Ẩn vùng đăng nhập */
        }
        
        h1, h2 { color: #333; }
        h3 { color: #555; font-weight: normal; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .button-group {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; flex-wrap: wrap;
        }
        .button-group > div { display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            border: none; padding: 10px 18px; border-radius: 5px;
            cursor: pointer; font-size: 16px; transition: background-color 0.3s, transform 0.1s;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-action { padding: 5px 10px; font-size: 14px; margin-right: 5px;}
        
        input[type="file"] { border: 1px solid #ccc; padding: 8px; border-radius: 4px; }
        #taskList { margin-top: 20px; border-collapse: collapse; width: 100%; table-layout: fixed; }
        #taskList th, #taskList td { 
            border: 1px solid #ddd; padding: 10px; text-align: left; 
            vertical-align: middle; word-wrap: break-word;
            font-size: 80%;
        }
        #taskList .btn-action { font-size: 14px; }
        #taskList th { 
            background-color: #f2f2f2; 
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .task-parent td { font-weight: bold; background-color: #e2e6ea; }
        .task-child td { font-weight: bold; background-color: #e9ecef; }
        #taskList th.text-right, #taskList td.text-right { text-align: right; }
        #status { margin-top: 15px; font-weight: bold; }
        #status.success { color: #28a745; }
        #status.error { color: #dc3545; }

        #summarySection {
            background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-top: 20px;
            display: flex; justify-content: space-between; flex-wrap: wrap;
        }
        .summary-column { width: 48%; }
        #summarySection p { margin: 5px 0; font-size: 16px; }
        #summarySection p strong { color: #333; }
        .percentage { color: #007bff; font-weight: bold; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 25px;
            border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); animation: slideIn 0.3s;
        }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }
        .modal-table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        .modal-table th, .modal-table td { border: 1px solid #ddd; padding: 8px; }
        .modal-table th { background-color: #f2f2f2; }
        .modal-table input { width: 95%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-table input:disabled { background-color: #e9ecef; cursor: not-allowed;}
        
        .col-tt { width: 4%; }
        .col-noidung { width: 30%; }
        .col-donvi, .col-soluong, .col-capdo, .col-dvt, .col-dongia { width: 9%; }
        .col-chiphi, .col-thanhtien { width: 12%; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        #scrollToTopBtn {
            display: none; position: fixed; bottom: 25px; right: 25px; z-index: 999;
            border: none; outline: none; background-color: #007bff; color: white; cursor: pointer;
            padding: 0; border-radius: 50%; font-size: 24px; width: 50px; height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background-color 0.3s, transform 0.2s;
        }
        #scrollToTopBtn:hover { background-color: #0056b3; transform: translateY(-2px); }

        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; background-color: #f9f9f9; min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; right: 0; border-radius: 4px;
        }
        .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px; }
        .dropdown-content a:hover { background-color: #f1f1f2; }
        .show { display: block; }
        
        .links-dropdown {
            display: block; position: absolute; background-color: #fff; min-width: 300px; max-width: 500px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 20; border-radius: 4px; border: 1px solid #ddd; padding: 5px;
        }
        .links-dropdown a {
            color: #0056b3; padding: 8px 12px; text-decoration: none; display: block; font-size: 14px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .links-dropdown a:hover { background-color: #f1f1f1; text-decoration: underline; }

        .modal-note {
            background-color: #f8f9fa; border-left: 4px solid #007bff; padding: 10px 15px;
            margin: 15px 0; font-size: 14px; color: #495057;
        }

        #yearSelect {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        #yearSelect:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .delete-confirm-modal {
            max-width: 500px;
        }

        .delete-confirm-modal input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        @media screen and (max-width: 768px) {
            .responsive-modal-table thead { display: none; }
            .responsive-modal-table, .responsive-modal-table tbody, .responsive-modal-table tr, .responsive-modal-table td {
                display: block; width: 100%;
            }
            .responsive-modal-table tr {
                margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; padding: 10px;
            }
            .responsive-modal-table td {
                display: flex; justify-content: space-between; padding-left: 50%;
                position: relative; text-align: right; border: none; padding-bottom: 5px;
            }
            .responsive-modal-table td:before {
                content: attr(data-label); position: absolute; left: 10px; width: 45%;
                padding-right: 10px; font-weight: bold; text-align: left;
            }
        }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    
    <div id="login-container">
        <img src="PVGLPG.gif" alt="Logo" style="width: 120px; height: auto; margin-bottom: 20px;">
        <h2>Đăng nhập Hệ thống</h2>
        <form id="login-form">
            <input type="text" id="email" 
                   value="n*****@pvgaslpg*****" 
                   data-real-email="namdinh@pvgaslpg.com.vn" 
                   readonly 
                   style="background-color: #e9ecef; cursor: not-allowed; text-align: center; color: #495057;">
            <input type="password" id="password" placeholder="Mật khẩu" required autofocus>
            <button type="submit" class="btn-primary">Đăng nhập</button>
            <p id="login-error" style="display: none;"></p>
        </form>
    </div>

    <div id="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <img src="PVGLPG.gif" alt="Logo" style="width: 100px; height: auto;">
            <h1 style="color: #008037; font-weight: bold; text-transform: uppercase; text-align: center; flex-grow: 1;">
                THEO DÕI KẾ HOẠCH BẢO DƯỠNG SỬA CHỮA
            </h1>
            <div style="width: 150px;"></div> 
        </div>
        
        <div class="button-group" style="padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <div>
                <button class="btn-secondary" onclick="recalculateAllCostsAndReload()" style="display: none;">Tải lại & Tính toán lại</button>
                <button class="btn-primary" onclick="openDataManagementModal()" style="display: none;">Quản lý Dữ liệu</button>
                <button id="deleteSelectedBtn" class="btn-danger" onclick="deleteSelectedTasks()" disabled style="display: none;">Xoá công việc đã chọn</button>
                <button class="btn-success" onclick="exportToExcel()">Xuất ra Excel</button>
            </div>
        </div>
        <div id="status"></div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <h2>Danh mục BDSC tại Trạm nạp LPG Nam Định</h2>
             <div>
                <label for="yearSelect" style="margin-right: 10px; font-weight: bold;">Năm:</label>
                <select id="yearSelect" onchange="changeYear(this.value)">
                </select>
            </div>
        </div>

        <div class="button-group" style="margin-bottom: 15px; justify-content: flex-start;">
             <div>
                <button id="multiExecuteBtn" class="btn-info" onclick="openMultiExecutionModal()" disabled>Thực hiện công việc đã chọn</button>
                <button id="searchExecutionBtn" class="btn-primary" onclick="openSearchModal()">Tra cứu thực hiện</button>
             </div>
        </div>

        <div id="summarySection"></div>

        <table id="taskList">
            <thead>
                <tr>
                    <th style="width: 3%;"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
                    <th style="width: 4%;">TT</th>
                    <th style="width: 34%;">Nội dung</th>
                    <th style="width: 7%;">Đơn vị</th>
                    <th style="width: 7%;">Số lượng</th>
                    <th class="text-right" style="width: 10%;">Chi phí</th>
                    <th class="text-right" style="width: 10%;">Chi phí thực hiện</th>
                    <th class="text-right" style="width: 10%;">Kế hoạch còn lại</th>
                    <th style="width: 3%;">Cấp độ</th>
                    <th style="width: 5%;">Hồ sơ</th>
                    <th style="width: 7%;">Hành động</th>
                </tr>
            </thead>
            <tbody id="taskListBody"></tbody>
        </table>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <div id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="modal-footer">
                <div id="modal-footer-left" style="float: left;"></div>
                <button id="modalDeleteButton" class="btn-danger" style="display: none; float: left;">Xóa</button>
                <button id="modalSaveButton" class="btn-success">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <div id="dataManagementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2>Quản lý Dữ liệu</h2>
            
            <div style="margin-top: 20px;">
                <h3>Nhập dữ liệu từ file Excel</h3>
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <p><small><i>Chú ý: để chương trình nhận đúng dữ liệu, hãy định dạng các dữ liệu số trong file Excel ở định dạng General.</i></small></p>
                <button class="btn-primary" onclick="importData()" style="margin-top: 10px;">Nhập dữ liệu</button>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc;">
                <h3>Xóa toàn bộ dữ liệu</h3>
                <p style="color: #dc3545;"><strong>Cảnh báo:</strong> Hành động này không thể hoàn tác.</p>
                <button class="btn-danger" onclick="openDeleteAllDataModal()">Xoá tất cả</button>
            </div>
        </div>
    </div>

    <div id="deleteAllDataModal" class="modal">
        <div class="modal-content delete-confirm-modal">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2>Xác nhận xóa toàn bộ dữ liệu</h2>
            <p style="color: #dc3545; font-weight: bold;">CẢNH BÁO: Bạn sắp xóa TOÀN BỘ dữ liệu. Hành động này không thể hoàn tác.</p>
            <p>Vui lòng nhập đầy đủ thông tin đăng nhập để xác nhận:</p>
            <div>
                <input type="text" id="deleteConfirmEmail" placeholder="Email đăng nhập">
                <input type="password" id="deleteConfirmPassword" placeholder="Mật khẩu">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAllModals()">Hủy</button>
                <button class="btn-danger" onclick="confirmDeleteAllData()">Xác nhận xóa toàn bộ</button>
            </div>
        </div>
    </div>
    
    <div id="uploadPdfModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" onclick="closeAllModals()">&times;</span>
            <h2 id="uploadPdfModalTitle">Tải lên Hồ sơ PDF</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mt-4">
                 <input type="file" id="pdf_file_input" accept=".pdf" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <div class="modal-footer">
                <button id="uploadPdfButton" class="btn-primary">Tải Lên</button>
            </div>
        </div>
    </div>

    <button id="scrollToTopBtn" title="Lên đầu trang">&uarr;</button>
    
    <div style="text-align: center; padding: 20px; color: #888; font-size: 12px;">
      Contact: hai.nm@pvgaslpg.com.vn
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // Sửa: Bỏ các import không cần thiết cho auth
        import { getAuth, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, updateDoc, deleteDoc, writeBatch, query, serverTimestamp, collectionGroup, limit } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyC6zogfxHV3zYs80GgQJ0HpLVxr_m3ArwU",
          authDomain: "bdsc-nd.firebaseapp.com",
          projectId: "bdsc-nd",
          storageBucket: "bdsc-nd.firebasestorage.app",
          messagingSenderId: "58759284467",
          appId: "1:58759284467:web:fae91a88456ec8f9cf1986",
          measurementId: "G-8G417NNC86"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Vẫn giữ auth cho các chức năng cần xác thực lại (nếu có)
        const db = getFirestore(app);

        // --- CẤU HÌNH GOOGLE DRIVE API ---
        const CLIENT_ID = "588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com";
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/drive.file";
        const FOLDER_ID = "1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P";

        // --- BIẾN TOÀN CỤC ---
        const statusDiv = document.getElementById('status');
        let selectedGrandchildren = new Set();
        let executionGroups = new Map();
        let noiDungMap = new Map();
        let tokenClient;
        let gapiReady = false;
        
        let currentYear = new Date().getFullYear();

        function getParentCollectionName() {
            return `công việc mẹ ${currentYear}`;
        }

        function initializeYearDropdown() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYearValue = new Date().getFullYear();
            const nextYear = currentYearValue + 1;
            
            yearSelect.innerHTML = '';
            
            const years = [currentYearValue, nextYear];
            
            for (let i = currentYearValue - 1; i >= currentYearValue - 3; i--) {
                years.unshift(i);
            }
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            currentYear = currentYearValue;
            yearSelect.value = currentYearValue;
        }

        window.changeYear = (year) => {
            currentYear = parseInt(year);
            fetchData();
        };

        async function ensureYearCollectionExists(year) {
            const collectionName = `công việc mẹ ${year}`;
            try {
                const testQuery = query(collection(db, collectionName), limit(1));
                const testSnapshot = await getDocs(testQuery);
                
                if (testSnapshot.empty) {
                    console.log(`Collection cho năm ${year} chưa tồn tại, sẽ được tạo khi có dữ liệu`);
                }
            } catch (error) {
                console.log(`Collection cho năm ${year} chưa tồn tại, sẽ được tạo khi có dữ liệu`);
            }
        }

        // --- AUTHENTICATION LOGIC ---
        
        // Sửa: Bỏ onAuthStateChanged và gọi trực tiếp các hàm khởi tạo
        window.addEventListener('DOMContentLoaded', () => {
            initializeYearDropdown();
            fetchData();
            initializeGoogleClients();
        });

        // Sửa: Xóa logic xử lý form đăng nhập vì nó đã bị ẩn
        // loginForm.addEventListener('submit', ...);

        // --- CÁC HÀM TIỆN ÍCH ---
        const formatNumber = (num) => num?.toLocaleString('vi-VN') || '0';
        
        const parseNumber = (str) => {
            if (str === null || str === undefined) return 0;
            let s = String(str).trim();
            if (s === '') return 0;
            const lastDot = s.lastIndexOf('.');
            const lastComma = s.lastIndexOf(',');
            let numberStr;
            if (lastComma > lastDot) {
                numberStr = s.replace(/\./g, '').replace(',', '.');
            } else {
                numberStr = s.replace(/,/g, '');
            }
            const result = parseFloat(numberStr);
            return isNaN(result) ? 0 : result;
        };
        
        const parseFormattedNumber = (str) => {
            if (str === null || str === undefined) return 0;
            let s = String(str).trim();
            if (s === '') return 0;
            const numberStr = s.replace(/\./g, '').replace(',', '.');
            const result = parseFloat(numberStr);
            return isNaN(result) ? 0 : result;
        };
        
        function initializeGoogleClients() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiReady = true;
            });
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: () => {},
            });
        }

        function ensureGapiAuthenticated() {
            return new Promise((resolve, reject) => {
                // Giả định người dùng đã đăng nhập vào Google ở một tab khác
                // Nếu không, các chức năng liên quan đến Drive sẽ yêu cầu popup
                if (gapi.client.getToken()) return resolve(gapi.client.getToken());
                tokenClient.requestAccessToken({ prompt: '' }); 
                tokenClient.callback = (resp) => {
                    if (resp.error) reject(resp.error);
                    else resolve(resp);
                    tokenClient.callback = () => {};
                };
            });
        }
        
        // --- NHẬP/XUẤT & QUẢN LÝ DỮ LIỆU (Giữ lại các hàm này) ---
        window.importData = () => {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files.length) {
                statusDiv.className = 'error'; statusDiv.innerText = "Vui lòng chọn một file Excel (.xlsx)."; return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    statusDiv.className = 'success'; statusDiv.innerText = "Đang đọc file...";
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });
                    const headers = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                    statusDiv.innerText = "Đã đọc file. Đang xử lý...";
                    
                    const taskTree = buildTaskTree(jsonData, headers);
                    calculateCosts(taskTree);
                    statusDiv.innerText = "Đang nhập dữ liệu vào Firestore...";
                    await writeTreeToFirestore(taskTree);
                    statusDiv.innerText = "Nhập dữ liệu thành công! Đang tải lại danh sách...";
                    closeAllModals();
                    await fetchData();
                } catch (error) { console.error("Lỗi khi nhập: ", error); statusDiv.className = 'error'; statusDiv.innerText = `Lỗi: ${error.message}`; }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        };

        const buildTaskTree = (jsonData, headers) => {
            const tree = []; let currentParent = null;
            const isRoman = /^[IVXLCDM]+$/i; const isNumber = /^\d+$/; const isSubNumber = /^\d+\.\d+$/;
            
            const availableColumns = {
                tt: headers.includes('TT'),
                noiDung: headers.includes('Nội dung') || headers.includes('NỘI DUNG CÔNG VIỆC'),
                donVi: headers.includes('Đơn vị'),
                soLuong: headers.includes('Số lượng') || headers.includes('Số lượng vật tư'),
                capDo: headers.includes('Cấp độ'),
                chiPhi: headers.includes('Chi phí') || headers.includes('Chi phí kế hoạch 2025'),
                chiPhiThucHien: headers.includes('Chi phí thực hiện'),
                keHoachConLai: headers.includes('Kế hoạch còn lại')
            };

            const findValue = (row, keys) => {
                for (const key of keys) {
                    if (headers.includes(key) && row[key] !== undefined && row[key] !== null && row[key] !== '') {
                        return row[key];
                    }
                }
                return undefined;
            };

            jsonData.forEach((row) => {
                const tt = availableColumns.tt ? String(row.TT || '').trim() : '';
                if (!tt) return;
                
                const data = { tt };
                
                if (availableColumns.noiDung) {
                    const noiDungValue = findValue(row, ['Nội dung', 'NỘI DUNG CÔNG VIỆC']);
                    if (noiDungValue !== undefined) data.noiDung = noiDungValue;
                }
                
                if (availableColumns.donVi) {
                    const donViValue = findValue(row, ['Đơn vị']);
                    if (donViValue !== undefined) data.donVi = donViValue;
                }
                
                if (availableColumns.soLuong) {
                    const soLuongValue = findValue(row, ['Số lượng', 'Số lượng vật tư']);
                    if (soLuongValue !== undefined) data.soLuong = soLuongValue;
                }
                
                if (availableColumns.capDo) {
                    const capDoValue = findValue(row, ['Cấp độ']);
                    if (capDoValue !== undefined) data.capDo = capDoValue;
                }
                
                if (availableColumns.chiPhi) {
                    const chiPhiValue = findValue(row, ['Chi phí', 'Chi phí kế hoạch 2025']);
                    if (chiPhiValue !== undefined) data.chiPhi = parseNumber(chiPhiValue);
                }
                
                if (availableColumns.chiPhiThucHien) {
                    const chiPhiThucHienValue = findValue(row, ['Chi phí thực hiện']);
                    if (chiPhiThucHienValue !== undefined) data.chiPhiThucHien = parseNumber(chiPhiThucHienValue);
                }
                
                if (availableColumns.keHoachConLai) {
                    const keHoachConLaiValue = findValue(row, ['Kế hoạch còn lại']);
                    if (keHoachConLaiValue !== undefined) {
                        data.keHoachConLai = parseNumber(keHoachConLaiValue);
                    } else if (data.chiPhi !== undefined && data.chiPhiThucHien !== undefined) {
                        data.keHoachConLai = data.chiPhi - data.chiPhiThucHien;
                    }
                }
                
                const taskNode = { id: tt, data };
                
                if (isSubNumber.test(tt)) {
                    taskNode.executions = [];
                    let i = 1;
                    while(true) {
                        const ngayTHKey = `Ngày TH (${i})`;
                        const hoSoLinkKey = `Hồ sơ Link (${i})`;
                        
                        const hasExecutionData = headers.includes(ngayTHKey) || 
                                               headers.includes(`Số lượng (${i})`) || 
                                               headers.includes(hoSoLinkKey);
                        
                        if (!hasExecutionData) break;
                        
                        const ngayThucHien = row[ngayTHKey];
                        const dvt = parseNumber(row[`Số lượng (${i})`]);
                        const thanhTien = parseNumber(row[`Thành tiền (${i})`]);
                        const hoSoLink = row[hoSoLinkKey];
                        
                        if (ngayThucHien || dvt > 0 || thanhTien > 0 || hoSoLink) {
                            taskNode.executions.push({
                                ngayThucHien: ngayThucHien, 
                                dvt: dvt,
                                donGia: parseNumber(row[`Đơn giá (${i})`]),
                                thanhTien: thanhTien, 
                                timestamp: row[`Timestamp (${i})`] || null,
                                lanThucHien: i, 
                                hoSoLink: hoSoLink || null
                            });
                        }
                        i++;
                    }
                }
                
                if (isRoman.test(tt)) {
                    taskNode.children = []; 
                    tree.push(taskNode); 
                    currentParent = taskNode;
                } else if (isNumber.test(tt) && currentParent) {
                    const existingChild = currentParent.children.find(c => c.id === tt);
                    if (existingChild) {
                        existingChild.data = { ...existingChild.data, ...taskNode.data, isHidden: false };
                    } else {
                        taskNode.grandchildren = []; 
                        currentParent.children.push(taskNode);
                    }
                } else if (isSubNumber.test(tt) && currentParent) {
                    const childId = tt.split('.')[0];
                    let childContainer = currentParent.children.find(c => c.id === childId);
                    if (!childContainer) {
                        childContainer = { 
                            id: childId, 
                            data: { tt: childId, noiDung: '(Công việc chung)', isHidden: true }, 
                            grandchildren: [] 
                        };
                        currentParent.children.push(childContainer);
                    }
                    if (!childContainer.grandchildren) childContainer.grandchildren = [];
                    childContainer.grandchildren.push(taskNode);
                }
            });
            return tree;
        };

        const calculateCosts = (tree) => {
            tree.forEach(parent => {
                let parentChiPhi = 0; let parentChiPhiThucHien = 0;
                (parent.children || []).forEach(child => {
                    const childChiPhi = (child.grandchildren || []).reduce((sum, gc) => sum + (gc.data.chiPhi || 0), 0);
                    const childChiPhiThucHien = (child.grandchildren || []).reduce((sum, gc) => sum + (gc.data.chiPhiThucHien || 0), 0);
                    if(child.data) {
                      child.data.chiPhi = childChiPhi;
                      child.data.chiPhiThucHien = childChiPhiThucHien;
                      child.data.keHoachConLai = childChiPhi - childChiPhiThucHien;
                    }
                    parentChiPhi += childChiPhi;
                    parentChiPhiThucHien += childChiPhiThucHien;
                });
                if(parent.data) {
                  parent.data.chiPhi = parentChiPhi;
                  parent.data.chiPhiThucHien = parentChiPhiThucHien;
                  parent.data.keHoachConLai = parentChiPhi - parentChiPhiThucHien;
                }
            });
        };

        const writeTreeToFirestore = async (tree) => {
            const batch = writeBatch(db);
            tree.forEach(p => {
                if (p.data && Object.keys(p.data).length > 1) batch.set(doc(db, getParentCollectionName(), p.id), p.data, { merge: true });
                (p.children || []).forEach(c => {
                    if (c.data && Object.keys(c.data).length > 1) batch.set(doc(db, getParentCollectionName(), p.id, "công việc con", c.id), c.data, { merge: true });
                    (c.grandchildren || []).forEach(gc => {
                        const grandchildRef = doc(db, `${getParentCollectionName()}/${p.id}/công việc con/${c.id}/công việc cháu`, gc.id);
                        if (gc.data && Object.keys(gc.data).length > 1) batch.set(grandchildRef, gc.data, { merge: true });
                        if (gc.executions && gc.executions.length > 0) {
                            gc.executions.forEach(exec => {
                                const execDocRef = doc(collection(grandchildRef, "thực hiện"), String(exec.lanThucHien));
                                batch.set(execDocRef, exec);
                            });
                        }
                    });
                });
            });
            await batch.commit();
        };
        
        const naturalSort = (a, b) => {
            const partsA = String(a.id).split('.').map(v => parseInt(v, 10));
            const partsB = String(b.id).split('.').map(v => parseInt(v, 10));
            const len = Math.max(partsA.length, partsB.length);
            for (let i = 0; i < len; i++) {
                const valA = partsA[i] || 0;
                const valB = partsB[i] || 0;
                if (valA !== valB) return valA - valB;
            }
            return 0;
        };
        
        window.toggleDropdown = (event) => {
            event.stopPropagation();
            document.querySelectorAll(".dropdown-content").forEach(content => {
                if (content !== event.target.nextElementSibling) content.classList.remove('show');
            });
            event.target.nextElementSibling.classList.toggle("show");
        };

        window.showLinks = (event) => {
            event.stopPropagation();
            const existingDropdown = document.getElementById('links-dropdown-container');
            if (existingDropdown) existingDropdown.remove();
            const button = event.target;
            const links = JSON.parse(button.dataset.links);
            if (!links || links.length === 0) return;
            const dropdown = document.createElement('div');
            dropdown.id = 'links-dropdown-container';
            dropdown.className = 'links-dropdown';
            links.forEach(link => {
                const a = document.createElement('a');
                a.href = link;
                a.textContent = link.length > 50 ? link.substring(0, 50) + '...' : link;
                a.target = '_blank';
                a.title = link;
                dropdown.appendChild(a);
            });
            document.body.appendChild(dropdown);
            const rect = button.getBoundingClientRect();
            dropdown.style.left = `${rect.left + window.scrollX}px`;
            dropdown.style.top = `${rect.bottom + window.scrollY}px`;
        };
        
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                document.querySelectorAll(".dropdown-content").forEach(content => content.classList.remove('show'));
            }
            const linksDropdown = document.getElementById('links-dropdown-container');
            if (linksDropdown && !linksDropdown.contains(event.target) && !event.target.matches('[data-links]')) {
                 linksDropdown.remove();
            }
        };

        window.fetchData = async () => {
            const tableBody = document.getElementById('taskListBody');
            tableBody.innerHTML = `<tr><td colspan="11">Đang tải dữ liệu...</td></tr>`;
            try {
                await ensureYearCollectionExists(currentYear);
                
                const executedGrandchildPaths = new Set();
                const hoSoLinkMap = new Map();
                const execQuery = query(collectionGroup(db, 'thực hiện'));
                const execSnapshot = await getDocs(execQuery);
                execSnapshot.forEach(docSnap => {
                    if (docSnap.ref.path.includes(getParentCollectionName())) {
                        const data = docSnap.data();
                        if ((data.dvt && parseNumber(data.dvt) !== 0) || data.hoSoLink) {
                            executedGrandchildPaths.add(docSnap.ref.parent.parent.path);
                        }
                        if (data.hoSoLink) {
                            const pathParts = docSnap.ref.path.split('/');
                            const grandchildPath = pathParts.slice(0, 6).join('/');
                            const childPath = pathParts.slice(0, 4).join('/');
                            const parentPath = pathParts.slice(0, 2).join('/');
                            [grandchildPath, childPath, parentPath].forEach(path => {
                                if (!hoSoLinkMap.has(path)) hoSoLinkMap.set(path, new Set());
                                hoSoLinkMap.get(path).add(data.hoSoLink);
                            });
                        }
                    }
                });

                let html = '';
                let totalChildTasks = 0, totalPlannedCost = 0, totalExecutedCost = 0;
                let totalExecutedChildTasks = 0, totalExecutedGrandchildren = 0;
                let totalGrandchildren = 0;
                
                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                const parents = parentSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                for (const parentData of parents) {
                    totalPlannedCost += parentData.chiPhi || 0;
                    totalExecutedCost += parentData.chiPhiThucHien || 0;
                    const parentPath = `${getParentCollectionName()}/${parentData.id}`;
                    const parentLinks = hoSoLinkMap.get(parentPath);
                    let parentHoSoHtml = '<td></td>';
                    if (parentLinks && parentLinks.size > 0) {
                        const linksJson = JSON.stringify(Array.from(parentLinks));
                        parentHoSoHtml = `<td><button class="btn-info btn-action" data-links='${linksJson}' onclick="showLinks(event)">Có</button></td>`;
                    }
                    html += `<tr class="task-parent">
                        <td></td><td>${parentData.tt}</td><td>${parentData.noiDung}</td><td></td><td></td>
                        <td class="text-right">${formatNumber(parentData.chiPhi)}</td>
                        <td class="text-right">${formatNumber(parentData.chiPhiThucHien)}</td>
                        <td class="text-right">${formatNumber(parentData.keHoachConLai)}</td>
                        <td></td>${parentHoSoHtml}
                        <td><div class="dropdown"><button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button><div class="dropdown-content"><a href="#" onclick="openAddModal('${parentPath}', 'child')">Thêm Thiết bị mới</a><a href="#" onclick="handleEditClick('${parentPath}', 'parent')">Sửa Nội dung</a></div></div></td>
                    </tr>`;

                    const childSnapshot = await getDocs(query(collection(db, parentPath, "công việc con")));
                    const children = childSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    for (const childData of children) {
                        totalChildTasks++;
                        
                        if (childData.daThucHien === true) {
                            totalExecutedChildTasks++;
                        }
                        
                        const childPath = `${parentPath}/công việc con/${childData.id}`;
                        const childLinks = hoSoLinkMap.get(childPath);
                        let childHoSoHtml = '<td></td>';
                        if (childLinks && childLinks.size > 0) {
                            const linksJson = JSON.stringify(Array.from(childLinks));
                            childHoSoHtml = `<td><button class="btn-info btn-action" data-links='${linksJson}' onclick="showLinks(event)">Có</button></td>`;
                        }
                        if (!childData.isHidden) {
                            html += `<tr class="task-child">
                                <td><input type="checkbox" class="child-checkbox" data-child-path="${childPath}" onchange="toggleGrandchildrenCheckboxes(this)"></td>
                                <td>${childData.tt}</td><td>${childData.noiDung}</td><td></td>
                                <td></td><td class="text-right">${formatNumber(childData.chiPhi)}</td>
                                <td class="text-right">${formatNumber(childData.chiPhiThucHien)}</td>
                                <td class="text-right">${formatNumber(childData.keHoachConLai)}</td>
                                <td>${childData.capDo || ''}</td>${childHoSoHtml}
                                <td><div class="dropdown"><button onclick="toggleDropdown(event)" class="btn-secondary btn-action dropbtn">Thêm/sửa</button><div class="dropdown-content"><a href="#" onclick="openAddModal('${childPath}', 'grandchild')">Thêm công việc chi tiết</a><a href="#" onclick="handleEditClick('${childPath}', 'child')">Sửa Nội dung</a></div></div></td>
                            </tr>`;
                        }
                        const grandchildSnapshot = await getDocs(query(collection(db, childPath, "công việc cháu")));
                        const grandchildren = grandchildSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        grandchildren.sort(naturalSort);
                        
                        for (const grandchildData of grandchildren) {
                            if (grandchildData.soLuong && parseNumber(grandchildData.soLuong) > 0) {
                                totalGrandchildren++;
                            }

                            const grandchildPath = `${childPath}/công việc cháu/${grandchildData.id}`;
                            const noiDungStyle = executedGrandchildPaths.has(grandchildPath) ? 'style="color: #5B77A8;"' : '';
                            const grandchildLinks = hoSoLinkMap.get(grandchildPath);
                            let grandchildHoSoHtml = '<td></td>';
                            if (grandchildLinks && grandchildLinks.size > 0) {
                                const linksJson = JSON.stringify(Array.from(grandchildLinks));
                                grandchildHoSoHtml = `<td><button class="btn-info btn-action" data-links='${linksJson}' onclick="showLinks(event)">Có</button></td>`;
                            }
                            const isExecuted = (grandchildData.chiPhiThucHien && grandchildData.chiPhiThucHien > 0) || (grandchildLinks && grandchildLinks.size > 0);
                            if (isExecuted) totalExecutedGrandchildren++;
                            html += `<tr>
                                <td><input type="checkbox" class="grandchild-checkbox" data-parent-path="${childPath}" data-path="${grandchildPath}" onchange="toggleSelection(this)"></td>
                                <td>${grandchildData.tt}</td><td ${noiDungStyle}>${grandchildData.noiDung}</td>
                                <td>${grandchildData.donVi}</td><td>${grandchildData.soLuong}</td>
                                <td class="text-right">${formatNumber(grandchildData.chiPhi)}</td>
                                <td class="text-right">${formatNumber(grandchildData.chiPhiThucHien)}</td>
                                <td class="text-right">${formatNumber(grandchildData.keHoachConLai)}</td>
                                <td>${grandchildData.capDo}</td>${grandchildHoSoHtml}
                                <td><button class="btn-secondary btn-action" onclick="handleEditClick('${grandchildPath}', 'grandchild')">Sửa</button></td>
                            </tr>`;
                        }
                    }
                }
                tableBody.innerHTML = html || `<tr><td colspan="11">Không có dữ liệu cho năm ${currentYear}.</td></tr>`;
                const childPercentage = totalChildTasks > 0 ? Math.round((totalExecutedChildTasks / totalChildTasks) * 100) : 0;
                const grandchildPercentage = totalGrandchildren > 0 ? Math.round((totalExecutedGrandchildren / totalGrandchildren) * 100) : 0;
                const costPercentage = totalPlannedCost > 0 ? Math.round((totalExecutedCost / totalPlannedCost) * 100) : 0;
                document.getElementById('summarySection').innerHTML = `
                    <div class="summary-column">
                        <p><strong>Tổng số đầu việc thiết bị:</strong> ${totalChildTasks}</p>
                        <p><strong>Tổng số đầu việc chi tiết cần thực hiện:</strong> ${totalGrandchildren}</p>
                        <p><strong>Tổng chi phí theo kế hoạch:</strong> ${formatNumber(totalPlannedCost)}</p>
                    </div>
                    <div class="summary-column">
                        <p><strong>Số đầu việc thiết bị đã thực hiện:</strong> ${totalExecutedChildTasks} <span class="percentage">(${childPercentage}%)</span></p>
                        <p><strong>Số đầu việc chi tiết đã thực hiện:</strong> ${totalExecutedGrandchildren} <span class="percentage">(${grandchildPercentage}%)</span></p>
                        <p><strong>Tổng chi phí đã thực hiện:</strong> ${formatNumber(totalExecutedCost)} <span class="percentage">(${costPercentage}%)</span></p>
                    </div>`;
                selectedGrandchildren.clear();
                document.getElementById('deleteSelectedBtn').disabled = true;
                statusDiv.innerText = '';
            } catch (error) { console.error("Lỗi tải dữ liệu: ", error); tableBody.innerHTML = `<tr><td colspan="11">Lỗi tải dữ liệu: ${error.message}</td></tr>`; }
        };

        window.recalculateAllCostsAndReload = async () => {
            if (!confirm("Bạn có muốn tính toán lại toàn bộ chi phí từ dữ liệu gốc không? Hành động này sẽ quét và cập nhật tất cả các mục công việc.")) return;
            const button = document.querySelector('button[onclick="recalculateAllCostsAndReload()"]');
            try {
                statusDiv.className = 'success';
                statusDiv.innerText = 'Đang tính toán lại toàn bộ dữ liệu... Vui lòng chờ.';
                button.disabled = true;
                const fieldsToRecalculate = ['chiPhi', 'chiPhiThucHien'];
                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                for (const parentDoc of parentSnapshot.docs) {
                    const childSnapshot = await getDocs(query(collection(parentDoc.ref, "công việc con")));
                    for (const childDoc of childSnapshot.docs) {
                        const grandchildSnapshot = await getDocs(query(collection(childDoc.ref, "công việc cháu")));
                        for (const grandchildDoc of grandchildSnapshot.docs) {
                            await recalculateGrandchildExecutionCost(grandchildDoc.ref.path);
                        }
                        await recalculateSingleParentCost(childDoc.ref.path, 'công việc cháu', fieldsToRecalculate);
                        await checkAndUpdateDaThucHien(childDoc.ref.path);
                    }
                    await recalculateSingleParentCost(parentDoc.ref.path, 'công việc con', fieldsToRecalculate);
                }
                statusDiv.innerText = 'Tính toán lại thành công! Đang tải lại dữ liệu mới...';
                await fetchData();
            } catch (error) {
                console.error("Lỗi khi tính toán lại toàn bộ:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Đã xảy ra lỗi: ${error.message}`;
            } finally {
                button.disabled = false;
            }
        };


        window.closeAllModals = () => document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
        window.openDataManagementModal = () => document.getElementById('dataManagementModal').style.display = 'block';

        window.openDeleteAllDataModal = () => {
            document.getElementById('deleteAllDataModal').style.display = 'block';
            document.getElementById('deleteConfirmEmail').value = '';
            document.getElementById('deleteConfirmPassword').value = '';
        };

        window.confirmDeleteAllData = async () => {
            const email = document.getElementById('deleteConfirmEmail').value;
            const password = document.getElementById('deleteConfirmPassword').value;
            
            if (!email || !password) {
                alert('Vui lòng nhập đầy đủ email và mật khẩu.');
                return;
            }

            const deleteButton = document.querySelector('#deleteAllDataModal .btn-danger');
            try {
                deleteButton.disabled = true;
                deleteButton.textContent = 'Đang xác nhận...';
                
                const credential = EmailAuthProvider.credential(email, password);
                await reauthenticateWithCredential(auth.currentUser, credential);
                
                statusDiv.className = 'success'; 
                statusDiv.innerText = "Đã xác thực thành công. Đang tiến hành xóa...";
                
                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                for (const parentDoc of parentSnapshot.docs) {
                    const childSnapshot = await getDocs(query(collection(parentDoc.ref, "công việc con")));
                    for (const childDoc of childSnapshot.docs) {
                        const grandchildSnapshot = await getDocs(query(collection(childDoc.ref, "công việc cháu")));
                        for (const grandchildDoc of grandchildSnapshot.docs) {
                            const executionSnapshot = await getDocs(query(collection(grandchildDoc.ref, "thực hiện")));
                            for(const execDoc of executionSnapshot.docs) await deleteDoc(execDoc.ref);
                            await deleteDoc(grandchildDoc.ref);
                        }
                        await deleteDoc(childDoc.ref);
                    }
                    await deleteDoc(parentDoc.ref);
                }
                statusDiv.innerText = "Đã xoá thành công.";
                closeAllModals();
                await fetchData();
            } catch (error) {
                console.error("Lỗi khi xoá: ", error);
                if (error.code === 'auth/invalid-credential') {
                    alert('Email hoặc mật khẩu không chính xác. Thao tác xóa đã bị hủy.');
                } else {
                    statusDiv.className = 'error'; 
                    statusDiv.innerText = "Lỗi khi xoá: " + error.message;
                }
            } finally {
                deleteButton.disabled = false;
                deleteButton.textContent = 'Xác nhận xóa toàn bộ';
            }
        };

        // SỬA LỖI & CẢI TIẾN: Hàm tạo bảng được nâng cấp để xử lý các đối tượng header phức tạp hơn.
        const createModalTable = (headers) => {
            let table = '<table class="modal-table"><thead><tr>';
            headers.forEach(h => {
                const style = h.width ? ` style="width: ${h.width};"` : '';
                const className = h.class ? ` class="${h.class}"` : '';
                const text = typeof h === 'object' ? h.text : h;
                table += `<th${style}${className}>${text}</th>`;
            });
            table += '</tr></thead><tbody>';
            return table;
        };


        const createInputRow = (path, data, level) => {
            const isParent = level === 'parent';
            const isChild = level === 'child';
            const isDisabled = (field) => {
                if (field === 'tt') return true;
                if ((isParent || isChild) && ['donVi', 'soLuong', 'chiPhi'].includes(field)) return true;
                if (isParent && field === 'capDo') return true;
                return false;
            };
            const chiPhiEvent = level === 'grandchild' ? 'onfocus="this.select()"' : '';
            return `<tr data-path="${path}">
                        <td class="col-tt"><input type="text" value="${data.tt || ''}" ${isDisabled('tt') ? 'disabled' : ''}></td>
                        <td class="col-noidung"><input type="text" value="${data.noiDung || ''}" data-field="noiDung"></td>
                        <td class="col-donvi"><input type="text" value="${data.donVi || ''}" data-field="donVi" ${isDisabled('donVi') ? 'disabled' : ''}></td>
                        <td class="col-soluong"><input type="text" value="${data.soLuong || ''}" data-field="soLuong" ${isDisabled('soLuong') ? 'disabled' : ''}></td>
                        <td class="col-chiphi"><input type="text" value="${formatNumber(data.chiPhi || 0)}" data-field="chiPhi" oninput="this.value=formatNumber(parseNumber(this.value))" ${chiPhiEvent} ${isDisabled('chiPhi') ? 'disabled' : ''}></td>
                        <td class="col-capdo"><input type="text" value="${data.capDo || ''}" data-field="capDo" ${isDisabled('capDo') ? 'disabled' : ''}></td>
                    </tr>`;
        };

        window.handleEditClick = async (docPath, level) => {
            if (level === 'grandchild') {
                const password = prompt("Vui lòng nhập mật khẩu để sửa công việc chi tiết:");
                if (password !== '24680') {
                    if (password !== null) {
                        alert("Mật khẩu không chính xác.");
                    }
                    return;
                }
            }

            const isGrandchild = level === 'grandchild';
            let pathsToEdit = [docPath];
            let title = 'Sửa thông tin công việc';
            if (isGrandchild && selectedGrandchildren.has(docPath) && selectedGrandchildren.size > 1) {
                pathsToEdit = Array.from(selectedGrandchildren).sort();
                title = `Sửa ${pathsToEdit.length} công việc đã chọn`;
            }
            document.getElementById('modalTitle').innerHTML = `<h2>${title}</h2>`;
            
            const showNote = pathsToEdit.some(path => path.includes('cháu'));
            const headers = [
                { text: 'TT', class: 'col-tt'}, { text: 'Nội dung', class: 'col-noidung' },
                { text: 'Đơn vị', class: 'col-donvi' }, { text: 'Số lượng', class: 'col-soluong' },
                { text: 'Chi phí', class: 'col-chiphi' }, { text: 'Cấp độ', class: 'col-capdo' }
            ];
            let table = createModalTable(headers);
            for (const path of pathsToEdit) {
                const docSnap = await getDoc(doc(db, path));
                if (docSnap.exists()) {
                    const currentLevel = path.includes('cháu') ? 'grandchild' : (path.includes('con') ? 'child' : 'parent');
                    table += createInputRow(path, docSnap.data(), currentLevel);
                }
            }
            table += '</tbody></table>';
            let modalBodyHTML = '';
            if (showNote) modalBodyHTML += '<div class="modal-note">Lưu ý: Khi sửa giá trị chi phí, hãy nhập dải số liền, không có ký tự phân tách hàng nghìn. Ví dụ nhập: 2513000</div>';
            modalBodyHTML += table;
            document.getElementById('modalBody').innerHTML = modalBodyHTML;
            document.getElementById('modalSaveButton').onclick = saveTasks;
            document.getElementById('modal-footer-left').innerHTML = '';
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
        };
        
        window.openAddModal = async (parentPath, level) => {
            const title = level === 'child' ? 'Thêm thiết bị vào bảng' : 'Thêm công việc chi tiết';
            document.getElementById('modalTitle').innerHTML = `<h2>${title}</h2>`;
            const subCollectionName = level === 'child' ? 'công việc con' : 'công việc cháu';
            const snapshot = await getDocs(query(collection(db, parentPath, subCollectionName)));
            const existingIds = snapshot.docs.map(d => d.id);
            let newTT;
            if (level === 'child') {
                newTT = String(existingIds.reduce((max, id) => Math.max(max, parseInt(id)), 0) + 1);
            } else {
                const parentTT = parentPath.split('/').pop();
                const maxSubId = existingIds.reduce((max, id) => Math.max(max, parseInt(id.split('.')[1] || 0)), 0);
                newTT = `${parentTT}.${maxSubId + 1}`;
            }
            const headers = [
                { text: 'TT', class: 'col-tt'}, { text: 'Nội dung', class: 'col-noidung' },
                { text: 'Đơn vị', class: 'col-donvi' }, { text: 'Số lượng', class: 'col-soluong' },
                { text: 'Chi phí', class: 'col-chiphi' }, { text: 'Cấp độ', class: 'col-capdo' }
            ];
            let table = createModalTable(headers);
            table += createInputRow(parentPath, { tt: newTT }, level);
            table += '</tbody></table>';
            
            let modalBodyHTML = '';
            if (level === 'grandchild') modalBodyHTML += '<div class="modal-note">Lưu ý: Khi nhập giá trị chi phí, hãy nhập dải số liền, không có ký tự phân tách hàng nghìn. Ví dụ nhập: 3621000</div>';
            modalBodyHTML += table;
            
            document.getElementById('modalBody').innerHTML = modalBodyHTML;
            document.getElementById('modalSaveButton').onclick = () => addNewTask(parentPath, level, newTT);
            document.getElementById('modal-footer-left').innerHTML = '';
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
        };

        const recalculateCostsForParents = async (paths) => {
            const uniqueParentChildPaths = new Set(paths.map(p => {
                if(p.includes('cháu')){
                    const parts = p.split('/');
                    const childPath = parts.slice(0, 4).join('/');
                    const parentPath = parts.slice(0, 2).join('/');
                    return JSON.stringify({ child: childPath, parent: parentPath });
                }
                return null;
            }).filter(p => p));
            
            const fieldsToRecalculate = ['chiPhi', 'chiPhiThucHien'];

            for (const pathStr of uniqueParentChildPaths) {
                const { child, parent } = JSON.parse(pathStr);
                await recalculateSingleParentCost(child, 'công việc cháu', fieldsToRecalculate);
                await recalculateSingleParentCost(parent, 'công việc con', fieldsToRecalculate);
            }
        };

        async function checkAndUpdateDaThucHien(childPath) {
            let hasHoSoLink = false;
            const grandchildSnapshot = await getDocs(query(collection(db, childPath, "công việc cháu")));
            for (const grandchildDoc of grandchildSnapshot.docs) {
                const execSnapshot = await getDocs(query(collection(grandchildDoc.ref, "thực hiện"), limit(1)));
                for (const execDoc of execSnapshot.docs) {
                    if (execDoc.data().hoSoLink) {
                        hasHoSoLink = true;
                        break;
                    }
                }
                if (hasHoSoLink) break;
            }

            const childDoc = await getDoc(doc(db, childPath));
            const chiPhiThucHien = childDoc.exists() ? (childDoc.data().chiPhiThucHien || 0) : 0;
            
            const daThucHien = (chiPhiThucHien > 0) || hasHoSoLink;

            await updateDoc(doc(db, childPath), { daThucHien: daThucHien });
        }


        const saveTasks = async () => {
            const saveButton = document.getElementById('modalSaveButton');
            try {
                saveButton.disabled = true; saveButton.textContent = 'Đang lưu...';
                const batch = writeBatch(db);
                const rows = document.querySelectorAll("#dataModal .modal-table tbody tr");
                const pathsToRecalculate = [];
                for(const row of rows) {
                    const path = row.dataset.path;
                    pathsToRecalculate.push(path);
                    const docRef = doc(db, path);
                    const updatedData = {};
                    row.querySelectorAll('input[data-field]').forEach(input => {
                        const field = input.dataset.field;
                        updatedData[field] = (field === 'chiPhi') ? parseFormattedNumber(input.value) : input.value;
                    });
                    if (path.includes('cháu')) {
                        const chiPhi = updatedData.chiPhi || 0;
                        const docSnap = await getDoc(docRef);
                        const chiPhiThucHien = docSnap.exists() ? (docSnap.data().chiPhiThucHien || 0) : 0;
                        updatedData.keHoachConLai = chiPhi - chiPhiThucHien;
                    }
                    batch.update(docRef, updatedData);
                }
                await batch.commit();
                await recalculateCostsForParents(pathsToRecalculate);
                closeAllModals();
                await fetchData();
                statusDiv.className = 'success'; statusDiv.innerText = `Đã cập nhật ${rows.length} công việc.`;
            } catch (error) {
                console.error("Lỗi khi lưu:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi lưu: ${error.message}`;
            } finally {
                saveButton.disabled = false; saveButton.textContent = 'Lưu thay đổi';
            }
        };

        window.addNewTask = async (parentPath, level, newTT) => {
            const row = document.querySelector("#dataModal .modal-table tbody tr");
            const newData = { tt: newTT, isHidden: false, chiPhi: 0, chiPhiThucHien: 0 };
            row.querySelectorAll('input[data-field]').forEach(input => {
                const field = input.dataset.field;
                newData[field] = (field === 'chiPhi') ? parseFormattedNumber(input.value) : input.value;
            });
            newData.keHoachConLai = newData.chiPhi || 0;
            if (!newData.noiDung) { alert("Nội dung công việc không được để trống!"); return; }
            const subCollectionName = level === 'child' ? 'công việc con' : 'công việc cháu';
            const newDocPath = `${parentPath}/${subCollectionName}/${newTT}`;
            await setDoc(doc(db, newDocPath), newData);
            await recalculateCostsForParents([newDocPath]);
            closeAllModals();
            await fetchData();
            statusDiv.className = 'success'; statusDiv.innerText = 'Thêm công việc thành công!';
        };
        
        const recalculateSingleParentCost = async (parentPath, subCollectionName, fieldsToSum) => {
            const snapshot = await getDocs(query(collection(db, parentPath, subCollectionName)));
            const dataToUpdate = {};
            fieldsToSum.forEach(field => dataToUpdate[field] = 0);
            snapshot.docs.forEach(d => {
                 fieldsToSum.forEach(field => { dataToUpdate[field] += (d.data()[field] || 0); });
            });
            const parentDocRef = doc(db, parentPath);
            dataToUpdate.keHoachConLai = (dataToUpdate.chiPhi || 0) - (dataToUpdate.chiPhiThucHien || 0);
            await updateDoc(parentDocRef, dataToUpdate);
        };
       
        window.calculateThanhTien = (input) => {
            const row = input.closest('tr');
            const dvt = parseNumber(row.querySelector('input[data-field="dvt"]').value);
            const donGia = parseNumber(row.querySelector('input[data-field="donGia"]').value);
            const thanhTien = dvt * donGia;
            row.querySelector('input[data-field="thanhTien"]').value = formatNumber(thanhTien);
        };

        const setupInputNavigation = (tableSelector) => {
            const inputs = document.querySelectorAll(`${tableSelector} input[type="number"]`);
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    const cell = e.target.closest('td');
                    if (!cell) return;
                    const row = cell.closest('tr');
                    const cellIndex = Array.from(row.children).indexOf(cell);
                    const allRows = Array.from(row.parentElement.children);
                    const rowIndex = allRows.indexOf(row);
                    let targetRow, targetCell, targetInput;

                    const focusOnTarget = () => {
                        if (targetInput) {
                            e.preventDefault();
                            targetInput.focus();
                            targetInput.select();
                        }
                    };

                    switch (e.key) {
                        case 'Enter':
                        case 'ArrowDown':
                            targetRow = allRows[rowIndex + 1];
                            if (targetRow) {
                                targetCell = targetRow.children[cellIndex];
                                targetInput = targetCell?.querySelector('input[type="number"]');
                                focusOnTarget();
                            } else { // Nếu là hàng cuối cùng, có thể cho phép hành vi mặc định (ví dụ: submit form)
                                e.preventDefault();
                            }
                            break;
                        case 'ArrowUp':
                            targetRow = allRows[rowIndex - 1];
                            if (targetRow) {
                                targetCell = targetRow.children[cellIndex];
                                targetInput = targetCell?.querySelector('input[type="number"]');
                                focusOnTarget();
                            }
                            break;
                        case 'ArrowLeft':
                             targetCell = row.children[cellIndex - 1];
                             targetInput = targetCell?.querySelector('input[type="number"]');
                             if(targetInput) focusOnTarget();
                             break;
                        case 'ArrowRight':
                             targetCell = row.children[cellIndex + 1];
                             targetInput = targetCell?.querySelector('input[type="number"]');
                             if(targetInput) focusOnTarget();
                             break;
                    }
                });
            });
        };

        window.openMultiExecutionModal = async () => {
            const selectedPaths = Array.from(selectedGrandchildren);
            if (selectedPaths.length === 0) { alert("Vui lòng chọn ít nhất một công việc để thực hiện."); return; }
            document.getElementById('modalTitle').innerHTML = `<h2>Thực hiện ${selectedPaths.length} công việc</h2>`;
            const headers = [
                {text: 'Tiểu mục', class: 'col-tt'}, {text: 'Nội dung', class: 'col-noidung'}, 
                {text: 'Số lượng', class: 'col-dvt'}, {text: 'Đơn giá', class: 'col-dongia'}, 
                {text: 'Thành tiền', class: 'col-thanhtien'}
            ];
            let modalBodyHTML = `<div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;"><label for="executionDate" style="font-weight: bold;">Ngày thực hiện:</label><input type="date" id="executionDate" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;" value="${new Date().toISOString().split('T')[0]}"></div>`;
            let table = createModalTable(headers);
            for (const path of selectedPaths) {
                const docSnap = await getDoc(doc(db, path));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    table += `<tr data-path="${path}" data-tt="${data.tt}">
                                <td><input type="text" value="${data.tt}" disabled></td>
                                <td><input type="text" value="${data.noiDung}" disabled></td>
                                <td><input type="number" data-field="dvt" oninput="calculateThanhTien(this)"></td>
                                <td><input type="number" data-field="donGia" oninput="calculateThanhTien(this)"></td>
                                <td><input type="text" data-field="thanhTien" value="0" disabled></td>
                              </tr>`;
                }
            }
            table += '</tbody></table>';
            modalBodyHTML += table;
            modalBodyHTML += `<div class="modal-note">Mẹo: Sử dụng phím Enter hoặc các phím mũi tên (↑, ↓) để di chuyển nhanh giữa các ô nhập liệu.</div>`;

            const footerLeftHTML = `<div style="display: flex; flex-direction: column; align-items: flex-start;">
                                      <div style="display: flex; gap: 10px;">
                                        <button class="btn-success" onclick="exportExecutionTemplate()">Xuất Excel (Mẫu)</button>
                                        <button class="btn-warning" onclick="document.getElementById('importExecFile').click()">Nhập từ Excel</button>
                                        <input type="file" id="importExecFile" onchange="importExecutionData(event)" style="display: none;" accept=".xlsx, .xls">
                                      </div>
                                      <small style="margin-top: 5px;"><i>Ghi chú: Số liệu trong file excel nhập vào phải có định dạng general (không có ký hiệu hàng nghìn).</i></small>
                                    </div>`;
            document.getElementById('modal-footer-left').innerHTML = footerLeftHTML;
            
            document.getElementById('modalBody').innerHTML = modalBodyHTML;
            document.getElementById('modalSaveButton').onclick = saveMultiExecutionData;
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
            
            setupInputNavigation('#dataModal .modal-table');
        };
        
        window.exportExecutionTemplate = () => {
            const rows = [['Tiểu mục', 'Nội dung', 'Số lượng', 'Đơn giá']];
            document.querySelectorAll('#dataModal .modal-table tbody tr').forEach(row => {
                const tt = row.querySelector('td:nth-child(1) input').value;
                const noiDung = row.querySelector('td:nth-child(2) input').value;
                rows.push([tt, noiDung, '', '']);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols'] = [ { wch: 10 }, { wch: 60 }, { wch: 15 }, { wch: 15 } ];
            XLSX.utils.book_append_sheet(wb, ws, 'Mẫu nhập liệu');
            XLSX.writeFile(wb, `MauNhapLieuThucHien_${currentYear}.xlsx`);
        };

        window.importExecutionData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    jsonData.forEach(excelRow => {
                        const tt = String(excelRow['Tiểu mục'] || '').trim();
                        if (!tt) return;
                        
                        const modalRow = document.querySelector(`#dataModal .modal-table tbody tr[data-tt="${tt}"]`);
                        if (modalRow) {
                            const soLuongInput = modalRow.querySelector('input[data-field="dvt"]');
                            const donGiaInput = modalRow.querySelector('input[data-field="donGia"]');
                            
                            if (excelRow['Số lượng'] !== undefined) soLuongInput.value = excelRow['Số lượng'];
                            if (excelRow['Đơn giá'] !== undefined) donGiaInput.value = excelRow['Đơn giá'];
                            
                            calculateThanhTien(soLuongInput);
                        }
                    });
                     statusDiv.className = 'success'; statusDiv.innerText = `Đã nhập dữ liệu từ file Excel vào biểu mẫu.`;
                } catch (error) {
                    console.error("Lỗi khi nhập Excel:", error);
                    statusDiv.className = 'error'; statusDiv.innerText = `Lỗi đọc file Excel: ${error.message}`;
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };


        window.saveMultiExecutionData = async () => {
            const saveButton = document.getElementById('modalSaveButton');
            try {
                saveButton.disabled = true; saveButton.textContent = 'Đang lưu...';
                const batch = writeBatch(db);
                const rows = document.querySelectorAll("#dataModal .modal-table tbody tr");
                const ngayThucHien = document.getElementById('executionDate').value;
                if (!ngayThucHien) throw new Error("Vui lòng chọn ngày thực hiện.");
                statusDiv.className = 'success'; statusDiv.innerText = "Đang lưu dữ liệu thực hiện...";
                const commonTimestamp = serverTimestamp();
                const pathsToRecalculate = [];
                const childPathsToUpdate = new Set();

                for (const row of rows) {
                    const grandchildPath = row.dataset.path;
                    const grandchildDocRef = doc(db, grandchildPath);
                    const grandchildDocSnap = await getDoc(grandchildDocRef);
                    if (!grandchildDocSnap.exists()) continue;

                    const childPath = grandchildDocRef.parent.parent.path;
                    childPathsToUpdate.add(childPath);

                    const grandchildData = grandchildDocSnap.data();
                    const initialChiPhi = grandchildData.chiPhi || 0;
                    const soLuong = parseNumber(row.querySelector('input[data-field="dvt"]').value);
                    const thanhTien = parseFormattedNumber(row.querySelector('input[data-field="thanhTien"]').value);
                    if (thanhTien <= 0 && (initialChiPhi !== 0 || soLuong <= 0)) continue;
                    pathsToRecalculate.push(grandchildPath);
                    const executionCollectionRef = collection(grandchildDocRef, 'thực hiện');
                    const executionSnapshot = await getDocs(query(executionCollectionRef));
                    const lanThucHien = executionSnapshot.size + 1;
                    const newExecutionData = { dvt: soLuong, donGia: parseNumber(row.querySelector('input[data-field="donGia"]').value), thanhTien: thanhTien, lanThucHien: lanThucHien, ngayThucHien: ngayThucHien, timestamp: commonTimestamp };
                    batch.set(doc(executionCollectionRef, String(lanThucHien)), newExecutionData);
                    const currentThucHien = grandchildData.chiPhiThucHien || 0;
                    const newThucHien = currentThucHien + thanhTien;
                    batch.update(grandchildDocRef, { chiPhiThucHien: newThucHien, keHoachConLai: grandchildData.chiPhi - newThucHien });
                }

                childPathsToUpdate.forEach(path => {
                    batch.update(doc(db, path), { daThucHien: true });
                });

                await batch.commit();
                await recalculateCostsForParents(pathsToRecalculate);
                closeAllModals();
                await fetchData();
                statusDiv.innerText = `Đã lưu các mục thực hiện thành công.`;
            } catch (error) {
                console.error("Lỗi khi lưu thực hiện:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi lưu: ${error.message}`;
            } finally {
                saveButton.disabled = false; saveButton.textContent = 'Lưu thay đổi';
            }
        };
        
        window.openSearchModal = async () => {
            statusDiv.className = 'success'; statusDiv.innerText = "Đang tìm kiếm dữ liệu thực hiện...";
            const q = query(collectionGroup(db, 'thực hiện'));
            const querySnapshot = await getDocs(q);
            executionGroups.clear();
            const uniqueGrandchildPaths = new Set();
            const uniqueChildPaths = new Set();
            querySnapshot.forEach(docSnap => {
                if (docSnap.ref.path.includes(getParentCollectionName())) {
                    const data = docSnap.data();
                    const pathParts = docSnap.ref.path.split('/');
                    const parentGrandchildPath = pathParts.slice(0, 6).join('/');
                    const parentChildPath = pathParts.slice(0, 4).join('/');
                    uniqueGrandchildPaths.add(parentGrandchildPath);
                    uniqueChildPaths.add(parentChildPath);
                    const executionData = { ...data, path: docSnap.ref.path, parentGrandchildPath, parentChildPath };
                    let timestampKey;
                    if (data.timestamp && typeof data.timestamp.toMillis === 'function') {
                        timestampKey = data.timestamp.toMillis();
                    } else if (data.timestamp) {
                        timestampKey = data.timestamp;
                    } else {
                        timestampKey = `fallback_${data.ngayThucHien}_${Math.random()}`;
                    }
                    if (!executionGroups.has(timestampKey)) executionGroups.set(timestampKey, {});
                    const group = executionGroups.get(timestampKey);
                    if (!group[parentChildPath]) group[parentChildPath] = [];
                    group[parentChildPath].push(executionData);
                }
            });
            noiDungMap.clear();
            const pathsToFetch = [...uniqueGrandchildPaths, ...uniqueChildPaths];
            const fetchPromises = Array.from(new Set(pathsToFetch)).map(path => getDoc(doc(db, path)));
            const allDocs = await Promise.all(fetchPromises);
            allDocs.forEach(docSnap => {
                if (docSnap.exists()) noiDungMap.set(docSnap.ref.path, docSnap.data().noiDung);
            });
            statusDiv.innerText = "";
            
            let modalHeader = `<div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2>Tra cứu các lần thực hiện công việc</h2>
                                <button class="btn-success" onclick="exportAllExecutionsToExcel()" style="margin-right: 20px;">Xuất toàn bộ ra Excel</button>
                               </div>`;
            document.getElementById('modalTitle').innerHTML = modalHeader;
            let table = `<table class="modal-table responsive-modal-table"><thead><tr><th style="width: 5%;">STT</th><th style="width: 10%;">Ngày T.Hiện</th><th>Trích yếu</th><th style="width: 15%; text-align:right;">Tổng chi phí</th><th style="width: 8%;">Số CV</th><th style="width: 15%;">Hành động</th></tr></thead><tbody>`;
            if (querySnapshot.empty) {
                 table += `<tr><td colspan="6">Không tìm thấy lần thực hiện nào.</td></tr>`;
            } else {
                const sortedGroups = Array.from(executionGroups.entries()).sort((a, b) => {
                    const timeA = typeof a[0] === 'number' ? a[0] : 0; const timeB = typeof b[0] === 'number' ? b[0] : 0;
                    return timeB - timeA;
                });
                let counter = 1;
                for (const [timestampKey, group] of sortedGroups) {
                    let totalCost = 0; let summaryHtml = ''; let grandchildCount = 0;
                    let hasHoSoLink = false;
                    
                    for (const childPath in group) {
                        for (const item of group[childPath]) {
                            if (item.hoSoLink) {
                                hasHoSoLink = true;
                                break;
                            }
                        }
                        if (hasHoSoLink) break;
                    }
                    
                    for (const childPath in group) {
                        const childName = noiDungMap.get(childPath) || 'Công việc con không xác định';
                        summaryHtml += `<div><strong>${childName}</strong></div>`;
                        const grandchildrenSummaries = group[childPath].map(item => {
                            totalCost += item.thanhTien; grandchildCount++;
                            const noiDung = noiDungMap.get(item.parentGrandchildPath) || '';
                            return noiDung.length > 20 ? noiDung.substring(0, 20) + '...' : noiDung;
                        }).join('; ');
                        summaryHtml += `<div style="padding-left: 15px;">${grandchildrenSummaries}</div>`;
                    }
                    const keyParam = typeof timestampKey === 'number' ? timestampKey : `'${timestampKey}'`;
                    
                    const profileButtonClass = hasHoSoLink ? 'btn-danger' : 'btn-info';
                    const profileButtonText = hasHoSoLink ? 'Thay hồ sơ' : 'Nhập hồ sơ';
                    
                    table += `<tr>
                        <td data-label="STT">${counter++}</td>
                        <td data-label="Ngày T.Hiện">${group[Object.keys(group)[0]][0].ngayThucHien}</td>
                        <td data-label="Trích yếu" style="line-height: 1.4;">${summaryHtml}</td>
                        <td data-label="Tổng chi phí" class="text-right">${formatNumber(totalCost)}</td>
                        <td data-label="Số CV">${grandchildCount}</td>
                        <td data-label="Hành động">
                            <button class="btn-secondary btn-action" onclick="openExecutionEditModal(${keyParam})">Sửa</button>
                            <button class="${profileButtonClass} btn-action" onclick="handleProfileUploadClick(${keyParam})">${profileButtonText}</button>
                        </td>
                    </tr>`;
                }
            }
            table += '</tbody></table>';
            document.getElementById('modalBody').innerHTML = table;
            document.getElementById('modal-footer-left').innerHTML = '';
            document.getElementById('modalSaveButton').style.display = 'none';
            document.getElementById('modalDeleteButton').style.display = 'none';
            document.getElementById('dataModal').style.display = 'block';
        };
        
        window.exportAllExecutionsToExcel = async () => {
            if (executionGroups.size === 0) { alert("Không có dữ liệu thực hiện để xuất."); return; }
            try {
                statusDiv.className = 'success'; statusDiv.innerText = "Đang chuẩn bị dữ liệu Excel...";
                const rows = [['STT', 'Ngày Thực Hiện', 'Nội dung Thiết bị', 'Nội dung Công việc', 'Số lượng', 'Đơn giá', 'Thành tiền', 'Link Hồ sơ']];
                const sortedGroups = Array.from(executionGroups.entries()).sort((a, b) => {
                    const timeA = typeof a[0] === 'number' ? a[0] : 0; const timeB = typeof b[0] === 'number' ? b[0] : 0;
                    return timeB - timeA;
                });
                let counter = 1;
                for (const [timestampKey, group] of sortedGroups) {
                    for (const childPath in group) {
                        const childName = noiDungMap.get(childPath) || 'N/A';
                        for (const exec of group[childPath]) {
                             const grandchildName = noiDungMap.get(exec.parentGrandchildPath) || 'N/A';
                             rows.push([ counter++, exec.ngayThucHien, childName, grandchildName, exec.dvt, exec.donGia, exec.thanhTien, exec.hoSoLink || '' ]);
                        }
                    }
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                ws['!cols'] = [ { wch: 5 }, { wch: 15 }, { wch: 40 }, { wch: 60 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 40 } ];
                XLSX.utils.book_append_sheet(wb, ws, 'Lịch sử thực hiện');
                XLSX.writeFile(wb, `LichSuThucHien_ToanBo_${currentYear}.xlsx`);
                statusDiv.innerText = "Xuất Excel thành công!";
            } catch (error) {
                console.error("Lỗi khi xuất toàn bộ lịch sử:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xuất Excel: ${error.message}`;
            }
        };

        window.openExecutionEditModal = async (timestampKey) => {
            const groupObject = executionGroups.get(timestampKey);
            if (!groupObject) return;
            const group = Object.values(groupObject).flat();
            const keyParam = typeof timestampKey === 'number' ? timestampKey : `'${timestampKey}'`;
            document.getElementById('modalTitle').innerHTML = `<h2>Sửa lần thực hiện ngày ${group[0].ngayThucHien}</h2>`;

            const headers = [
                { text: 'Mục', width: '4%' }, { text: 'Thiết bị', width: '25%' },
                { text: 'Tiểu mục', width: '4%' }, { text: 'Công việc chi tiết', width: '35%' },
                { text: 'Số lượng', width: '6%' }, { text: 'Đơn giá', width: '13%' }, { text: 'Thành tiền', width: '13%' }
            ];
            let table = createModalTable(headers);

            for (const execution of group) {
                const childSnap = await getDoc(doc(db, execution.parentChildPath));
                const grandchildSnap = await getDoc(doc(db, execution.parentGrandchildPath));
                const childData = childSnap.exists() ? childSnap.data() : { tt: 'N/A', noiDung: 'Không tìm thấy' };
                const grandchildData = grandchildSnap.exists() ? grandchildSnap.data() : { tt: 'N/A', noiDung: 'Không tìm thấy' };
                table += `<tr data-exec-path="${execution.path}" data-tt="${grandchildData.tt}">
                            <td><input type="text" value="${childData.tt}" disabled></td>
                            <td><input type="text" value="${childData.noiDung}" disabled></td>
                            <td><input type="text" value="${grandchildData.tt}" disabled></td>
                            <td><input type="text" value="${grandchildData.noiDung}" disabled></td>
                            <td><input type="number" data-field="dvt" value="${execution.dvt}" oninput="calculateThanhTien(this)"></td>
                            <td><input type="number" data-field="donGia" value="${execution.donGia}" oninput="calculateThanhTien(this)"></td>
                            <td><input type="text" data-field="thanhTien" value="${formatNumber(execution.thanhTien)}" disabled></td>
                         </tr>`;
            }
            table += '</tbody></table>';

            const modalBodyFooter = `<div class="modal-note">Mẹo: Sử dụng phím Enter hoặc các phím mũi tên (↑, ↓) để di chuyển nhanh giữa các ô nhập liệu.</div>`;
            document.getElementById('modalBody').innerHTML = table + modalBodyFooter;
            
            const footerLeftHTML = `<div style="display: flex; flex-direction: column; align-items: flex-start;">
                                        <div style="display: flex; gap: 10px;">
                                            <button class="btn-success" onclick="exportSingleExecutionToExcel(${keyParam})">Xuất Excel</button>
                                            <button class="btn-warning" onclick="document.getElementById('importExecEditsFile').click()">Nhập từ Excel</button>
                                            <input type="file" id="importExecEditsFile" onchange="importExecutionEdits(event)" style="display: none;" accept=".xlsx, .xls">
                                        </div>
                                        <small style="margin-top: 5px;"><i>Ghi chú: Số liệu trong file excel nhập vào phải có định dạng general.</i></small>
                                    </div>`;

            document.getElementById('modal-footer-left').innerHTML = footerLeftHTML;
            
            document.getElementById('modalSaveButton').style.display = 'block';
            document.getElementById('modalSaveButton').onclick = () => saveExecutionEdits();
            document.getElementById('modalDeleteButton').style.display = 'block';
            document.getElementById('modalDeleteButton').onclick = () => handleDeleteExecution(timestampKey);
            document.getElementById('dataModal').style.display = 'block';

            setupInputNavigation('#dataModal .modal-table');
        };

        window.importExecutionEdits = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    jsonData.forEach(excelRow => {
                        const tt = String(excelRow['Tiểu mục'] || '').trim();
                        if (!tt) return;
                        
                        const modalRow = document.querySelector(`#dataModal .modal-table tbody tr[data-tt="${tt}"]`);
                        if (modalRow) {
                            const soLuongInput = modalRow.querySelector('input[data-field="dvt"]');
                            const donGiaInput = modalRow.querySelector('input[data-field="donGia"]');
                            
                            if (excelRow['Số lượng'] !== undefined) soLuongInput.value = excelRow['Số lượng'];
                            if (excelRow['Đơn giá'] !== undefined) donGiaInput.value = excelRow['Đơn giá'];
                            
                            calculateThanhTien(soLuongInput);
                        }
                    });
                    statusDiv.className = 'success'; statusDiv.innerText = `Đã nhập dữ liệu từ file Excel vào biểu mẫu.`;
                } catch (error) {
                    console.error("Lỗi khi nhập Excel:", error);
                    statusDiv.className = 'error'; statusDiv.innerText = `Lỗi đọc file Excel: ${error.message}`;
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };


        const recalculateGrandchildExecutionCost = async (grandchildPath) => {
            const grandchildDocRef = doc(db, grandchildPath);
            const execSnapshot = await getDocs(collection(grandchildDocRef, 'thực hiện'));
            const newChiPhiThucHien = execSnapshot.docs.reduce((sum, d) => sum + (d.data().thanhTien || 0), 0);
            const grandchildDocSnap = await getDoc(grandchildDocRef);
            if(grandchildDocSnap.exists()) {
                const chiPhi = grandchildDocSnap.data().chiPhi || 0;
                await updateDoc(grandchildDocRef, { chiPhiThucHien: newChiPhiThucHien, keHoachConLai: chiPhi - newChiPhiThucHien });
            }
        };
        
        window.exportSingleExecutionToExcel = async (timestampKey) => {
            try {
                const groupObject = executionGroups.get(timestampKey);
                if (!groupObject) throw new Error("Không tìm thấy dữ liệu thực hiện.");
                const group = Object.values(groupObject).flat();
                const ngayThucHien = group[0]?.ngayThucHien || 'UnknownDate';
                const headers = ['Mục', 'Thiết bị', 'Tiểu mục', 'Công việc chi tiết', 'Số lượng', 'Đơn giá', 'Thành tiền'];
                const rows = [headers];
                for (const exec of group) {
                    const childSnap = await getDoc(doc(db, exec.parentChildPath));
                    const grandchildSnap = await getDoc(doc(db, exec.parentGrandchildPath));
                    const childData = childSnap.exists() ? childSnap.data() : { tt: 'N/A', noiDung: 'N/A' };
                    const grandchildData = grandchildSnap.exists() ? grandchildSnap.data() : { tt: 'N/A', noiDung: 'N/A' };
                    rows.push([ childData.tt, childData.noiDung, grandchildData.tt, grandchildData.noiDung, exec.dvt, exec.donGia, exec.thanhTien ]);
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                ws['!cols'] = [{ wch: 8 }, { wch: 40 }, { wch: 8 }, { wch: 60 }, { wch: 12 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, ws, 'Chi tiết thực hiện');
                XLSX.writeFile(wb, `ChiTietThucHien_${ngayThucHien}_${currentYear}.xlsx`);
                statusDiv.className = 'success';
                statusDiv.innerText = "Xuất Excel thành công.";
            } catch (error) {
                console.error("Lỗi khi xuất Excel:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Lỗi khi xuất Excel: ${error.message}`;
                throw error;
            }
        };

        window.handleDeleteExecution = async (timestampKey) => {
            if (!confirm("Bạn có chắc chắn muốn xóa lần thực hiện này không? Hành động này không thể hoàn tác.")) return;
            const exportBeforeDelete = confirm("Bạn có muốn xuất chi tiết lần thực hiện này ra Excel trước khi xóa không?");
            try {
                if (exportBeforeDelete) {
                    await exportSingleExecutionToExcel(timestampKey);
                    statusDiv.innerText = "Xuất Excel thành công. Chuẩn bị xóa...";
                }
                statusDiv.className = 'success';
                statusDiv.innerText = "Đang xóa dữ liệu...";
                const group = Object.values(executionGroups.get(timestampKey)).flat();
                const batch = writeBatch(db);
                const pathsToRecalculate = new Set(group.map(exec => exec.parentGrandchildPath));
                
                const childPathsToCheck = new Set(group.map(exec => exec.parentChildPath));

                group.forEach(exec => batch.delete(doc(db, exec.path)));
                await batch.commit();

                statusDiv.innerText = "Đã xóa. Đang cập nhật lại chi phí và trạng thái...";
                
                const recalcPromises = Array.from(pathsToRecalculate).map(path => recalculateGrandchildExecutionCost(path));
                await Promise.all(recalcPromises);
                
                for (const childPath of childPathsToCheck) {
                    await checkAndUpdateDaThucHien(childPath);
                }

                await recalculateCostsForParents(Array.from(pathsToRecalculate));
                closeAllModals();
                await fetchData();
                statusDiv.innerText = "Đã xóa thành công lần thực hiện.";
            } catch (error) {
                 console.error("Lỗi khi xóa thực hiện:", error);
                 statusDiv.className = 'error';
                 statusDiv.innerText = `Lỗi khi xóa: ${error.message}`;
            }
        };

        window.saveExecutionEdits = async () => {
            const saveButton = document.getElementById('modalSaveButton');
            try {
                saveButton.disabled = true; saveButton.textContent = 'Đang lưu...';
                const batch = writeBatch(db);
                const rows = document.querySelectorAll("#dataModal .modal-table tbody tr");
                const pathsToRecalculate = new Set();
                const childPathsToUpdate = new Set();

                for (const row of rows) {
                    const execPath = row.dataset.execPath;
                    const parentGrandchildPath = execPath.substring(0, execPath.lastIndexOf('/thực hiện/'));
                    const childPath = parentGrandchildPath.substring(0, parentGrandchildPath.lastIndexOf('/công việc cháu/'));
                    
                    pathsToRecalculate.add(parentGrandchildPath);
                    childPathsToUpdate.add(childPath);

                    const updatedData = { 
                        dvt: parseNumber(row.querySelector('input[data-field="dvt"]').value), 
                        donGia: parseNumber(row.querySelector('input[data-field="donGia"]').value), 
                        thanhTien: parseFormattedNumber(row.querySelector('input[data-field="thanhTien"]').value) 
                    };
                    batch.update(doc(db, execPath), updatedData);
                }

                childPathsToUpdate.forEach(path => {
                    batch.update(doc(db, path), { daThucHien: true });
                });

                await batch.commit();
                const recalcPromises = Array.from(pathsToRecalculate).map(path => recalculateGrandchildExecutionCost(path));
                await Promise.all(recalcPromises);
                
                for (const childPath of childPathsToUpdate) {
                    await checkAndUpdateDaThucHien(childPath);
                }
                
                await recalculateCostsForParents(Array.from(pathsToRecalculate));
                closeAllModals();
                await fetchData();
                statusDiv.className = 'success'; statusDiv.innerText = "Đã cập nhật thành công lần thực hiện.";
            } catch (error) {
                console.error("Lỗi khi sửa thực hiện:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi sửa: ${error.message}`;
            } finally {
                saveButton.disabled = false; saveButton.textContent = 'Lưu thay đổi';
            }
        };

        window.handleProfileUploadClick = async (timestampKey) => {
            if (!gapiReady) { alert("Dịch vụ Google chưa sẵn sàng, vui lòng thử lại sau giây lát."); return; }
            try {
                await ensureGapiAuthenticated();
                const uploadModal = document.getElementById('uploadPdfModal');
                const uploadButton = document.getElementById('uploadPdfButton');
                document.getElementById('pdf_file_input').value = '';
                uploadModal.style.display = 'block';
                uploadButton.onclick = () => performPdfUpload(timestampKey);
            } catch(error) {
                console.error("Lỗi xác thực Google:", error);
                statusDiv.className = 'error';
                statusDiv.innerText = 'Lỗi xác thực với Google. Vui lòng thử lại.';
            }
        };

        async function performPdfUpload(timestampKey) {
            const uploadButton = document.getElementById('uploadPdfButton');
            const fileInput = document.getElementById('pdf_file_input');
            const file = fileInput.files[0];
            if (!file) { alert('Vui lòng chọn một tệp PDF.'); return; }
            try {
                uploadButton.disabled = true; uploadButton.textContent = 'Đang tải...';
                statusDiv.className = 'success'; statusDiv.innerText = 'Đang tải tệp lên Google Drive...';
                const metadata = { name: file.name, mimeType: 'application/pdf', parents: [FOLDER_ID] };
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                    body: formData
                });
                if (!response.ok) { const error = await response.json(); throw new Error(`Lỗi API: ${error.error.message}`); }
                const fileData = await response.json();
                const fileLink = `https://drive.google.com/file/d/${fileData.id}/view`;
                statusDiv.innerText = 'Đang lưu đường link vào cơ sở dữ liệu...';
                const group = Object.values(executionGroups.get(timestampKey) || {}).flat();
                if (group.length > 0) {
                    const batch = writeBatch(db);
                    group.forEach(exec => batch.update(doc(db, exec.path), { hoSoLink: fileLink }));
                    
                    const childPathsToUpdate = new Set(group.map(exec => exec.parentChildPath));
                     childPathsToUpdate.forEach(path => {
                        batch.update(doc(db, path), { daThucHien: true });
                    });
                    
                    await batch.commit();
                }
                closeAllModals();
                await fetchData();
                statusDiv.innerText = `Tải lên và cập nhật hồ sơ thành công!`;
            } catch (error) {
                console.error('Lỗi khi tải tệp hồ sơ:', error);
                statusDiv.className = 'error';
                statusDiv.innerText = `Đã xảy ra lỗi: ${error.message}`;
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Tải Lên';
            }
        }

        window.toggleSelection = (checkbox) => {
            const grandchildPath = checkbox.dataset.path;
            if (checkbox.checked) selectedGrandchildren.add(grandchildPath); 
            else selectedGrandchildren.delete(grandchildPath);
            updateParentCheckboxState(checkbox.dataset.parentPath);
            const isDisabled = selectedGrandchildren.size === 0;
            document.getElementById('multiExecuteBtn').disabled = isDisabled;
            document.getElementById('deleteSelectedBtn').disabled = isDisabled;
        };
        
        const updateParentCheckboxState = (parentPath) => {
             const parentCheckbox = document.querySelector(`.child-checkbox[data-child-path="${parentPath}"]`);
             if (!parentCheckbox) return;
             const siblingCheckboxes = document.querySelectorAll(`.grandchild-checkbox[data-parent-path="${parentPath}"]`);
             const totalSiblings = siblingCheckboxes.length;
             let checkedCount = 0;
             siblingCheckboxes.forEach(cb => { if(cb.checked) checkedCount++; });
             if (checkedCount === 0) {
                 parentCheckbox.checked = false; parentCheckbox.indeterminate = false;
             } else if (checkedCount === totalSiblings) {
                 parentCheckbox.checked = true; parentCheckbox.indeterminate = false;
             } else {
                 parentCheckbox.checked = false; parentCheckbox.indeterminate = true;
             }
        };

        window.toggleGrandchildrenCheckboxes = (childCheckbox) => {
            const childPath = childCheckbox.dataset.childPath;
            const isChecked = childCheckbox.checked;
            childCheckbox.indeterminate = false;
            const grandchildrenCheckboxes = document.querySelectorAll(`.grandchild-checkbox[data-parent-path="${childPath}"]`);
            grandchildrenCheckboxes.forEach(cb => {
                if (cb.checked !== isChecked) {
                    cb.checked = isChecked;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        };

        window.toggleAllCheckboxes = (masterCheckbox) => {
            const isChecked = masterCheckbox.checked;
            document.querySelectorAll('.child-checkbox, .grandchild-checkbox').forEach(cb => {
                cb.indeterminate = false;
                if (cb.checked !== isChecked) {
                    cb.checked = isChecked;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        };
        
        window.deleteSelectedTasks = async () => {
            if (selectedGrandchildren.size === 0) {
                alert("Vui lòng chọn ít nhất một công việc để xoá."); return;
            }
            try {
                for (const path of selectedGrandchildren) {
                    const execSnapshot = await getDocs(query(collection(db, path, 'thực hiện')));
                    if (!execSnapshot.empty) {
                        const taskDoc = await getDoc(doc(db, path));
                        const taskName = taskDoc.exists() ? taskDoc.data().noiDung : 'không xác định';
                        alert(`Công việc "${taskName}" (Mục ${taskDoc.data().tt}) đã được thực hiện nên không được phép xóa.`);
                        return;
                    }
                }
            } catch (error) {
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi kiểm tra công việc: ${error.message}`; return;
            }

            const password = prompt("Hành động này không thể hoàn tác. Vui lòng nhập mật khẩu để xác nhận xoá:");
            if (password === null) return; 
            if (password !== '97531') {
                alert('Mật khẩu không chính xác. Thao tác đã bị huỷ.'); return;
            }
            if (!confirm(`Bạn có chắc chắn muốn xoá vĩnh viễn ${selectedGrandchildren.size} công việc đã chọn không?`)) return;
            
            const deleteButton = document.getElementById('deleteSelectedBtn');
            try {
                deleteButton.disabled = true;
                statusDiv.className = 'success'; statusDiv.innerText = `Đang xoá ${selectedGrandchildren.size} công việc...`;
                const batch = writeBatch(db);
                const pathsToRecalculate = Array.from(selectedGrandchildren);
                pathsToRecalculate.forEach(path => batch.delete(doc(db, path)));
                await batch.commit();
                statusDiv.innerText = "Đã xoá. Đang tính toán lại chi phí...";
                await recalculateCostsForParents(pathsToRecalculate);
                await fetchData();
                statusDiv.innerText = `Đã xoá thành công ${pathsToRecalculate.length} công việc.`;
            } catch (error) {
                console.error("Lỗi khi xoá công việc:", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xoá: ${error.message}`;
            } finally {
                deleteButton.disabled = selectedGrandchildren.size === 0;
            }
        };

        window.exportToExcel = async () => {
            statusDiv.className = 'success';
            statusDiv.innerText = 'Đang chuẩn bị dữ liệu. Vui lòng chờ...';
            try {
                statusDiv.innerText = 'Đang tổng hợp dữ liệu các lần thực hiện...';
                const executionsMap = new Map();
                let maxExecutions = 0;
                const execQuery = query(collectionGroup(db, 'thực hiện'));
                const execSnapshot = await getDocs(execQuery);
                execSnapshot.forEach(docSnap => {
                    if (docSnap.ref.path.includes(getParentCollectionName())) {
                        const data = docSnap.data();
                        const parentGrandchildPath = docSnap.ref.parent.parent.path;
                        if (!executionsMap.has(parentGrandchildPath)) executionsMap.set(parentGrandchildPath, []);
                        executionsMap.get(parentGrandchildPath).push(data);
                    }
                });
                executionsMap.forEach((executions) => {
                    executions.sort((a, b) => a.lanThucHien - b.lanThucHien);
                    if (executions.length > maxExecutions) maxExecutions = executions.length;
                });
                statusDiv.innerText = 'Đang tạo cấu trúc file Excel...';
                const baseHeaders = ['TT', 'Nội dung', 'Đơn vị', 'Số lượng', 'Chi phí', 'Chi phí thực hiện', 'Kế hoạch còn lại', 'Cấp độ'];
                const executionHeaders = [];
                for (let i = 1; i <= maxExecutions; i++) {
                    executionHeaders.push(`Ngày TH (${i})`, `Số lượng (${i})`, `Đơn giá (${i})`, `Thành tiền (${i})`, `Timestamp (${i})`, `Hồ sơ Link (${i})`);
                }
                const fullHeaders = [...baseHeaders, ...executionHeaders];
                const rows = [];
                const boldRows = new Set(); 
                const parentSnapshot = await getDocs(query(collection(db, getParentCollectionName())));
                const parents = parentSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                for (const parentData of parents) {
                    boldRows.add(rows.length);
                    const parentRowData = [ parentData.tt, parentData.noiDung, parentData.donVi, parentData.soLuong, parentData.chiPhi, parentData.chiPhiThucHien, parentData.keHoachConLai, parentData.capDo ];
                    parentRowData.push(...Array(maxExecutions * 6).fill('')); 
                    rows.push(parentRowData);
                    const childSnapshot = await getDocs(query(collection(db, `${getParentCollectionName()}/${parentData.id}/công việc con`)));
                    const children = childSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    for (const childData of children) {
                        boldRows.add(rows.length); 
                        const childRowData = [ childData.tt, childData.noiDung, childData.donVi, childData.soLuong, childData.chiPhi, childData.chiPhiThucHien, childData.keHoachConLai, childData.capDo ];
                        childRowData.push(...Array(maxExecutions * 6).fill('')); 
                        rows.push(childRowData);
                        const grandchildSnapshot = await getDocs(query(collection(db, `${getParentCollectionName()}/${parentData.id}/công việc con/${childData.id}/công việc cháu`)));
                        const grandchildren = grandchildSnapshot.docs.map(d => ({id: d.id, path: d.ref.path, ...d.data()})).sort((a,b) => naturalSort(a,b));
                        for (const grandchildData of grandchildren) {
                            const grandchildRowData = [ grandchildData.tt, grandchildData.noiDung, grandchildData.donVi, grandchildData.soLuong, grandchildData.chiPhi, grandchildData.chiPhiThucHien, grandchildData.keHoachConLai, grandchildData.capDo ];
                            const executions = executionsMap.get(grandchildData.path) || [];
                            executions.forEach(exec => {
                                const execTimestamp = exec.timestamp && typeof exec.timestamp.toMillis === 'function' ? new Date(exec.timestamp.toMillis()).toLocaleString('vi-VN') : (exec.timestamp || '');
                                grandchildRowData.push(exec.ngayThucHien, exec.dvt, exec.donGia, exec.thanhTien, execTimestamp, exec.hoSoLink || '');
                            });
                            const paddingCount = (maxExecutions - executions.length) * 6;
                            if (paddingCount > 0) grandchildRowData.push(...Array(paddingCount).fill(''));
                            rows.push(grandchildRowData);
                        }
                    }
                }
                statusDiv.innerText = 'Đang ghi dữ liệu ra file, vui lòng chờ trong giây lát...';
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([fullHeaders, ...rows]);
                for (let i = 0; i < rows.length; i++) {
                    if (boldRows.has(i)) {
                        for (let j = 0; j < baseHeaders.length; j++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: i + 1, c: j });
                            if(ws[cellAddress]) {
                                if(!ws[cellAddress].s) ws[cellAddress].s = {};
                                if(!ws[cellAddress].s.font) ws[cellAddress].s.font = {};
                                ws[cellAddress].s.font.bold = true;
                            }
                        }
                    }
                }
                const colWidths = [ { wch: 8 }, { wch: 60 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 } ];
                for (let i = 0; i < maxExecutions; i++) {
                    colWidths.push({ wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 22 }, { wch: 40 });
                }
                ws['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws, 'Danh sách công việc');
                XLSX.writeFile(wb, `KeHoachBaoDuong_DayDu_${currentYear}.xlsx`);
                statusDiv.innerText = 'Xuất file Excel thành công!';
            } catch (error) {
                console.error("Lỗi khi xuất Excel: ", error);
                statusDiv.className = 'error'; statusDiv.innerText = `Lỗi khi xuất file: ${error.message}`;
            }
        };

        const scrollToTopBtn = document.getElementById("scrollToTopBtn");
        window.onscroll = () => {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollToTopBtn.style.display = "block";
            } else {
                scrollToTopBtn.style.display = "none";
            }
        };
        scrollToTopBtn.onclick = () => { window.scrollTo({top: 0, behavior: 'smooth'}); };

    </script>

</body>
</html>